<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#667eea">
    <title>Hasil Transkrip Nilai</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            margin: 0; 
            padding: 20px; 
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            flex-direction: column; 
        }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); 
            width: 90%; 
            max-width: 1000px; 
            text-align: center; 
        }
        h1 { 
            color: #333; 
            margin-bottom: 20px; 
            font-size: 28px;
        }
        #student-info { 
            text-align: left; 
            margin-bottom: 25px; 
            padding: 20px; 
            background-color: #f8f9fa; 
            border-radius: 8px; 
            border-left: 5px solid #667eea; 
            font-size: 16px; 
            line-height: 1.6; 
        }
        .loader { 
            border: 8px solid #f3f3f3; 
            border-radius: 50%; 
            border-top: 8px solid #667eea; 
            width: 60px; 
            height: 60px; 
            animation: spin 1s linear infinite; 
            margin: 20px auto; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        #error-message { 
            color: #d9534f; 
            background-color: #f2dede; 
            border: 1px solid #ebccd1; 
            padding: 15px; 
            border-radius: 8px; 
            display: none; 
        }
        .back-button { 
            display: inline-block; 
            margin-top: 30px; 
            background: #5cb85c; 
            color: white; 
            padding: 12px 25px; 
            border-radius: 8px; 
            text-decoration: none; 
            font-weight: 600; 
            transition: background-color 0.3s ease;
        }
        .back-button:hover {
            background: #4cae4c;
        }
        .container, #student-info, #table-container, .back-button {
            transition: all 0.3s ease;
        }
        @media (hover: hover) {
            .back-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(92, 184, 92, 0.3);
            }
        }
        @media (pointer: coarse) {
            .back-button {
                padding: 12px 24px;
            }
        }
        /* Penyesuaian Bootstrap untuk tampilan yang lebih baik */
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: #f8f9fa; /* Warna striping yang sama dengan info */
        }
        
        /* Jarak di atas tabel */
        #table-container {
            margin-top: 30px;
        }
        
        /* Responsive table styling untuk mobile */
        @media (max-width: 768px) {
            .container {
                width: 95%;
                padding: 20px 15px;
                margin: 10px;
            }
            
            .table-responsive {
                margin: 0 -15px;
                width: calc(100% + 30px);
            }
            
            #transcript-table {
                font-size: 14px;
                min-width: 600px; /* Minimum width untuk memastikan tabel tidak terlalu sempit */
            }
            
            #transcript-table th,
            #transcript-table td {
                padding: 8px 6px;
                white-space: nowrap;
                vertical-align: middle;
            }
            
            /* Kolom yang bisa di-wrap */
            #transcript-table td:nth-child(3) { /* Nama Mata Kuliah */
                white-space: normal;
                min-width: 120px;
                max-width: 150px;
            }
            
            /* Scroll horizontal yang lebih smooth */
            .table-responsive::-webkit-scrollbar {
                height: 8px;
            }
            
            .table-responsive::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 4px;
            }
            
            .table-responsive::-webkit-scrollbar-thumb {
                background: #667eea;
                border-radius: 4px;
            }
            
            .table-responsive::-webkit-scrollbar-thumb:hover {
                background: #5a6fd8;
            }
        }
        
        /* Extra small devices */
        @media (max-width: 576px) {
            .container {
                width: 98%;
                padding: 15px 10px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            #student-info {
                margin-bottom: 35px;
            }
            
            #table-container {
                margin-top: 25px;
            }
            
            #transcript-table {
                font-size: 13px;
                min-width: 550px;
            }
            
            #transcript-table th,
            #transcript-table td {
                padding: 6px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“œ Hasil Transkrip Nilai</h1>
        <div id="loader" class="loader"></div>
        <div id="student-info" style="display: none;"></div>
        <div id="error-message"></div>
        
        <div class="table-responsive" id="table-container" style="display: none;">
            <table class="table table-striped table-hover table-bordered" id="transcript-table">
                <thead>
                    <tr>
                        <th>No.</th><th>Kode MK</th><th>Nama Mata Kuliah</th><th>SKS</th><th>Nilai</th><th>Bobot</th><th>SKS x Bobot</th>
                    </tr>
                </thead>
                <tbody id="transcript-body"></tbody>
                <tfoot id="transcript-foot"></tfoot>
            </table>
        </div>
        
        <a href="index.html" class="back-button">Kembali ke Pencarian</a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const loader = document.getElementById('loader');
            const studentInfoDiv = document.getElementById('student-info');
            const tableContainer = document.getElementById('table-container');
            const tableBody = document.getElementById('transcript-body');
            const tableFoot = document.getElementById('transcript-foot');
            const errorMessageDiv = document.getElementById('error-message');

            const urlParams = new URLSearchParams(window.location.search);
            const nim = urlParams.get('nim');

            if (!nim) {
                showError('NIM tidak ditemukan. Silakan kembali ke halaman awal.');
                return;
            }

            const originalApiUrl = `http://103.164.170.234:8081/api/public/mhstranskrip/${nim}?api=01071194`;
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(originalApiUrl)}`;

            // Fungsi untuk menampilkan pesan error
            function showError(message) {
                loader.style.display = 'none';
                errorMessageDiv.textContent = message;
                errorMessageDiv.style.display = 'block';
            }

            // Fungsi untuk menghitung bobot berdasarkan nilai
            function calculateBobot(nilai) {
                if (!nilai || nilai === 'N/A') return 'N/A';
                const grade = nilai.trim().toUpperCase();
                const bobotMap = {
                    'A': 4.00, 'A-': 3.67, 'B+': 3.33, 'B': 3.00,
                    'B-': 2.67, 'C+': 2.33, 'C': 2.00, 'C-': 1.67,
                    'D+': 1.33, 'D': 1.00, 'E': 0.00, 'F': 0.00
                };
                return bobotMap[grade] !== undefined ? bobotMap[grade] : 'N/A';
            }

            // Fungsi helper untuk menemukan nilai properti dengan nama yang bervariasi
            function findProperty(item, possibleNames) {
                for (let name of possibleNames) {
                    if (item[name] !== undefined && item[name] !== null && item[name] !== '') {
                        return item[name];
                    }
                }
                return 'N/A';
            }

            fetch(proxyUrl)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    return response.json();
                })
                .then(result => {
                    loader.style.display = 'none';

                    // Coba cari data transkrip
                    const studentDataArray = result.data || result.transkrip || result.nilai || (Array.isArray(result) ? result : null);
                    if (!studentDataArray || !Array.isArray(studentDataArray) || studentDataArray.length === 0) {
                        throw new Error('Data transkrip tidak ditemukan dalam respons API.');
                    }
                    
                    const studentInfo = studentDataArray[0];

                    const studentNim = findProperty(studentInfo, ['STB', 'nim', 'NIM', 'nim_mahasiswa']);
                    const studentName = findProperty(studentInfo, ['NMMHS', 'nama', 'NAMA', 'nama_mahasiswa', 'nama_lengkap']);
                    const studentProdi = findProperty(studentInfo, ['NMPRGSTD', 'prodi', 'PRODI', 'program_studi', 'jurusan']);

                    studentInfoDiv.innerHTML = `<strong>NIM:</strong> ${studentNim}<br><strong>Nama:</strong> ${studentName}<br><strong>Program Studi:</strong> ${studentProdi}`;
                    studentInfoDiv.style.display = 'block';

                    let totalSKS = 0;
                    let totalSksxBobot = 0;

                    const tableRows = studentDataArray.map((item, index) => {
                        const kodeMK = findProperty(item, ['KDMTK', 'kodemk', 'kode_mk', 'kode', 'mk']);
                        const namaMK = findProperty(item, ['NMMTK', 'namamk', 'nama_mk', 'mata_kuliah', 'nama_mata_kuliah']);
                        const sks = parseFloat(findProperty(item, ['SKS', 'sks', 'credits'])) || 0;
                        const nilai = findProperty(item, ['nil', 'nilai', 'grade', 'nilai_huruf', 'huruf']);
                        const bobot = calculateBobot(nilai);
                        const sksxBobot = (sks > 0 && bobot !== 'N/A') ? (sks * bobot) : 0;

                        if (sks > 0 && bobot !== 'N/A') {
                            totalSKS += sks;
                            totalSksxBobot += sksxBobot;
                        }

                        return `<tr>
                            <td>${index + 1}</td>
                            <td>${kodeMK}</td>
                            <td>${namaMK}</td>
                            <td>${sks}</td>
                            <td>${nilai}</td>
                            <td>${bobot}</td>
                            <td>${sksxBobot.toFixed(2)}</td>
                        </tr>`;
                    }).join('');

                    tableBody.innerHTML = tableRows;

                    const ipk = totalSKS > 0 ? (totalSksxBobot / totalSKS).toFixed(2) : 'N/A';
                    tableFoot.innerHTML = `<tr><th colspan="3">Total SKS</th><th>${totalSKS}</th><th colspan="2">IPK</th><th>${ipk}</th></tr>`;
                    tableContainer.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    showError('Gagal mengambil atau memproses data. Cek konsol browser (F12) untuk detail.');
                });
        });
    </script>
</body>
</html>